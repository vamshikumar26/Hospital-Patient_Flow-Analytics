create MASTER KEY ENCRYPTION by PASSWORD = "<<password>>;

create database scoped CREDENTIAL storage_credential 
with IDENTITY = 'Managed Identity';

--defining data source

CREATE external data SOURCE gold_data_source
WITH (
    type = HADOOP,
    LOCATION = 'abfss://<<containername>>@<storageaccount>>.dfs.core.windows.net',
    CREDENTIAL = storage_credential
)

-- define parquet format
create EXTERNAL FILE FORMAT parquet_file_format
with(
    FORMAT_TYPE = PARQUET
)



--create tables
--patient Dimension table
create EXTERNAL table dim_patient(
    patient_id varchar(50),
    gender VARCHAR(50),
    age INT,
    effective_from DATETIME2,
    surrogate_key BIGINT,
    effective_to DATETIME2,
    is_current BIT
)
WITH(
    LOCATION = 'dim_patient/',
    DATA_SOURCE = gold_data_source,
    FILE_FORMAT = parquet_file_format
)

--Department dimension
create EXTERNAL table dim_department(
    department NVARCHAR(200),
    hospital_id INT,

    surrogate_key BIGINT
   
)
WITH(
    LOCATION = 'dim_department/',
    DATA_SOURCE = gold_data_source,
    FILE_FORMAT = parquet_file_format
)



--Fact Dimension
create external TABLE fact_patient_flow(
    fact_id BIGINT,
    patient_sk BIGINT,
    department_sk BIGINT,
    admission_time DATETIME2,
    discharge_time DATETIME2,
    admission_date DATE,
    length_of_stay_hours FLOAT,
    is_currently_admitted BIT,
    bed_id INT,
    evnet_ingestion_time DATETIME2
)
with(
    LOCATION = 'fact_patient_flow/',
    DATA_SOURCE = gold_data_source,
    FILE_FORMAT = parquet_file_format
)


select * from fact_patient_flow